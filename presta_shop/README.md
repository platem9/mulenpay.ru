# Модуль оплаты MulenPay для PrestaShop

Модуль добавляет способ оплаты MulenPay в интернет‑магазин PrestaShop: покупатель выбирает MulenPay на шаге оформления, система создаёт заказ в статусе «Ожидание оплаты MulenPay», формирует платёж через API MulenPay и перенаправляет клиента на платёжную страницу. После оплаты MulenPay отправляет колбэк (webhook) на ваш сайт, и заказ автоматически помечается как оплаченный.

Поддерживается PrestaShop 1.7+ (и 8.x).

## Возможности
- Выбор способа оплаты «MulenPay» при оформлении заказа.
- Автоматическое создание платежа через MulenPay API.
- Перенаправление покупателя на страницу оплаты MulenPay.
- Приём входящих уведомлений (webhook) об успешной оплате или отмене.
- Автоматическое обновление статуса заказа: «Оплата принята» / «Отменён».
- Сопоставление заказа с ID платежа MulenPay в собственной таблице БД.

## Установка
1. Скопируйте папку `modules/mulenpay` в каталог модулей вашего магазина PrestaShop (если используете этот репозиторий целиком — просто положите его в корень проекта).
2. В админ‑панели PrestaShop перейдите: Модули → Менеджер модулей → Найдите «MulenPay» и нажмите «Установить».
3. После установки откройте настройки модуля и заполните поля конфигурации (см. ниже).

## Настройка
В настройках модуля необходимо указать:
- API Key (Bearer) — ключ API MulenPay для заголовка Authorization. Получить в личном кабинете MulenPay в настройках магазина.
- Secret для подписи — секрет для генерации поля `sign` в запросе создания платежа.
- Shop ID — идентификатор вашего магазина в MulenPay.
- API Base URL — адрес API (по умолчанию `https://mulenpay.ru/api`).
- Webhook token — произвольная строка для защиты URL обратного вызова (колбэка). Этот токен нужно добавить в URL при настройке колбэка в личном кабинете MulenPay.

После сохранения настроек модуль покажет сформированный URL колбэка. Пример:

```
https://example.com/index.php?fc=module&module=mulenpay&controller=callback&token=XXXXXXXXXXXXXXX
```

Укажите этот URL в личном кабинете MulenPay, чтобы получать уведомления об оплатах.

## Как это работает
1. Покупатель выбирает «MulenPay» как способ оплаты.
2. Модуль создаёт заказ в статусе «Ожидание оплаты MulenPay» и отправляет запрос `POST /v2/payments` в API MulenPay с данными заказа.
   - В запросе указываются: `currency`, `amount`, `uuid` (референс заказа PrestaShop), `description`, `items` и т.д.
   - Поле `sign` формируется как sha1-конкатенация: `currency + amount + shopId + secret`.
   - Авторизация — через заголовок `Authorization: Bearer <API Key>`.
3. В ответе MulenPay возвращает `paymentUrl` и `id` платежа. Покупатель перенаправляется на `paymentUrl` для завершения оплаты.
4. После оплаты MulenPay отправляет POST‑запрос на указанный вами URL колбэка. Тело запроса содержит, в частности: `uuid`, `payment_status` (`success` или `cancel`), `id`, `amount` и т.п.
5. Модуль обрабатывает колбэк:
   - Находит заказ по `uuid` (референсу заказа PrestaShop).
   - При `payment_status = success` переводит заказ в статус «Оплата принята» и создаёт запись об оплате с транзакцией MulenPay.
   - При `payment_status = cancel` устанавливает статус «Отменён».

## Поля платежа (по спецификации MulenPay)
- currency — валюта оплаты (используется `rub`).
- amount — сумма оплаты строкой с двумя знаками после запятой (например, `"1000.50"`).
- uuid — идентификатор заказа на стороне магазина (используется `Order::reference`).
- shopId — ID магазина из ЛК MulenPay (подставляется модулем автоматически).
- sign — sha1 от конкатенации `currency + amount + shopId + secret`.
- items — массив позиций заказа. Для каждой позиции указываются: `description`, `price`, `quantity`, `vat_code`, `payment_subject` (по умолчанию 1 — «Товар»), `payment_mode` (по умолчанию 4 — «Полный расчёт»).

### НДС (vat_code)
Модуль автоматически сопоставляет ставку налога PrestaShop:
- 20% → код 6
- 10% → код 2
- 0% → код 0
Если ставка не распознана, используется код 0 (без НДС).

## Таблица БД
При установке создаётся таблица `<prefix>mulenpay_payment` для связи заказов PrestaShop с платежами MulenPay:
- id_mulenpay_payment — PK
- id_order — ID заказа в PrestaShop
- id_cart — ID корзины
- mulen_payment_id — ID платежа в MulenPay
- status — текущий статус (по данным колбэка)
- created_at, updated_at — даты создания/обновления записи

## URL колбэка
Формат:
```
https://<ваш_домен>/index.php?fc=module&module=mulenpay&controller=callback&token=<ваш_token>
```
Где `token` — значение из настроек модуля. Если токен указан, модуль будет требовать его соответствия в запросе; иначе колбэк будет принят без проверки токена.

Пример тела колбэка (из спецификации):
```json
{
  "id": 12345,
  "amount": 100.50,
  "currency": "RUB",
  "uuid": "external-uuid-123",
  "payment_status": "success"
}
```

## Тестирование
- Оформите заказ и выберите MulenPay — вас перенаправит на платёжную страницу MulenPay.
- Для проверки обработки колбэка можно отправить запрос вручную:

```bash
curl -X POST \
  "https://example.com/index.php?fc=module&module=mulenpay&controller=callback&token=ВАШ_ТОКЕН" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 12345,
    "amount": 100.50,
    "currency": "RUB",
    "uuid": "<REFERENCE_ВАШЕГО_ЗАКАЗА>",
    "payment_status": "success"
  }'
```

## Замечания
- Валюта отправляется как `rub` (нижний регистр), в соответствии с OpenAPI спецификацией.
- Поле `amount` отправляется строкой с двумя знаками после запятой.
- Поддерживаются только базовые сценарии: создание платежа, успешная оплата и отмена. Функции холда/возврата/чека реализуйте по аналогии при необходимости.
- Если в папке модуля отсутствует `logo.png`, логотип в способе оплаты просто не отображается.

## Структура
- `modules/mulenpay/mulenpay.php` — основной класс модуля (настройки, хуки, установка).
- `modules/mulenpay/classes/MulenPayClient.php` — простой HTTP‑клиент для MulenPay API.
- `modules/mulenpay/controllers/front/payment.php` — создание заказа, вызов API, редирект на оплату.
- `modules/mulenpay/controllers/front/callback.php` — обработка входящих колбэков.
- `modules/mulenpay/views/templates/hook/payment_return.tpl` — простой шаблон после возврата.
- `docs/api.yml` — спецификация API MulenPay.

## Лицензия
MIT (если не указано иное).