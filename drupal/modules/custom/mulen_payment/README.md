
# Модуль оплаты Mulen Pay для Drupal

Этот модуль предоставляет интеграцию с платежной системой Mulen Pay для вашего сайта на Drupal.

## Установка

1.  Скопируйте папку `mulen_payment` в директорию `modules/custom` вашего сайта.
2.  Перейдите на страницу "Расширения" в административной панели Drupal (`/admin/modules`).
3.  Найдите модуль "Mulen Payment" и активируйте его.

## Настройка

1.  После активации модуля перейдите на страницу настроек:
    `Администрирование > Конфигурация > Веб-сервисы > Mulen Payment Settings` (`/admin/config/services/mulen_payment`).
2.  Введите ваш `Shop ID` и `Secret Key`, полученные в личном кабинете Mulen Pay.
3.  Сохраните настройки.

## Использование

### Создание платежа

Для создания платежа вам необходимо вызвать сервис `mulen_payment.service` и его метод `createPayment()`.

Пример:

```php
$order_data = [
  'amount' => 100.50, // Сумма заказа
  'uuid' => 'ORDER-12345', // Уникальный ID заказа на вашем сайте
  'description' => 'Оплата заказа #12345', // Описание заказа
  'items' => [
    [
      'description' => 'Товар 1',
      'price' => 50.00,
      'quantity' => 1,
      'vat_code' => 0, // Код ставки НДС (0 - без НДС)
      'payment_subject' => 1, // Код предмета платежа (1 - товар)
      'payment_mode' => 4, // Код метода платежа (4 - полный расчет)
    ],
    [
      'description' => 'Товар 2',
      'price' => 50.50,
      'quantity' => 1,
      'vat_code' => 0,
      'payment_subject' => 1,
      'payment_mode' => 4,
    ],
  ],
];

$mulen_payment_service = \Drupal::service('mulen_payment.service');
$response = $mulen_payment_service->createPayment($order_data);

if ($response && $response['success']) {
  // Перенаправляем пользователя на страницу оплаты
  $payment_url = $response['paymentUrl'];
  // ... код для перенаправления
}
else {
  // Обработка ошибки создания платежа
}
```

### Обработка Webhook (Callback)

Модуль автоматически предоставляет эндпоинт для получения уведомлений от Mulen Pay о статусе платежа.

**URL для Webhook:** `https://ваш-сайт.ру/payments/callback`

Этот URL необходимо указать в настройках вашего магазина в личном кабинете Mulen Pay.

Когда платежная система отправит уведомление, модуль запишет информацию в лог Drupal.
Вы можете расширить функционал контроллера `MulenPaymentController` для обработки этих уведомлений, например, для изменения статуса заказа в вашей системе.

**Расположение контроллера:** `modules/custom/mulen_payment/src/Controller/MulenPaymentController.php`

В методе `callback()` вы можете добавить свою логику. На данный момент он только логирует полученные данные.

**Важно:** В целях безопасности вам следует добавить проверку подписи запроса от платежной системы в методе `callback()`, чтобы убедиться, что запрос действительно пришел от Mulen Pay.
